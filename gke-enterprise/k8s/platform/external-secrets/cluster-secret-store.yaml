# ============================================================
# External Secrets Operator
# ClusterSecretStore — connects to GCP Secret Manager
# using Workload Identity (no key files).
# ============================================================

---
# Kubernetes Service Account for ESO
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: external-secrets
  annotations:
    iam.gke.io/gcp-service-account: external-secrets-gsa@myorg-gke-prod.iam.gserviceaccount.com

---
# ClusterSecretStore — cluster-wide Secret Manager backend
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: gcp-secretmanager
spec:
  provider:
    gcpsm:
      projectID: myorg-gke-prod
      auth:
        workloadIdentity:
          clusterLocation: europe-west1
          clusterName: prod-cluster-primary
          clusterProjectID: myorg-gke-prod
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

---
# ── Example ExternalSecret — how teams use this ──────────────
# Teams create ExternalSecrets in their own namespace.
# This is a reference example — not applied directly.
#
# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#   name: my-app-db-password
#   namespace: team-payments
# spec:
#   refreshInterval: 1h
#   secretStoreRef:
#     name: gcp-secretmanager
#     kind: ClusterSecretStore
#   target:
#     name: my-app-db-password
#     creationPolicy: Owner
#   data:
#     - secretKey: password
#       remoteRef:
#         key: payments-db-password     # Secret Manager secret name
#         version: latest               # or pin to a specific version

---
# Platform secret — ArgoCD admin password
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: argocd-admin-password
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcp-secretmanager
    kind: ClusterSecretStore
  target:
    name: argocd-secret
    creationPolicy: Merge    # merge into existing argocd-secret
  data:
    - secretKey: admin.password
      remoteRef:
        key: argocd-admin-password

---
# Platform secret — Grafana admin password
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grafana-admin-password
  namespace: monitoring
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcp-secretmanager
    kind: ClusterSecretStore
  target:
    name: grafana-admin-password
    creationPolicy: Owner
  data:
    - secretKey: admin-password
      remoteRef:
        key: grafana-admin-password

---
# Platform secret — Alertmanager Slack webhook
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: alertmanager-slack-webhook
  namespace: monitoring
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcp-secretmanager
    kind: ClusterSecretStore
  target:
    name: alertmanager-slack-webhook
    creationPolicy: Owner
  data:
    - secretKey: webhook-url
      remoteRef:
        key: alertmanager-slack-webhook
